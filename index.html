<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mentor - Your Personal Career Guide</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/phosphor-icons/1.4.2/css/phosphor.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-bg-color: white;
            --text-color: #1e293b;
            --text-muted-color: #64748b;
            --border-color: #e2e8f0;
            --primary-btn-bg: linear-gradient(45deg, #4f46e5, #7c3aed);
            --primary-btn-hover-bg: linear-gradient(45deg, #4338ca, #6d28d9);
            --progress-bar-bg: #e0e7ff;
            --progress-bar-fill: #4f46e5;
            --glow-color: rgba(79, 70, 229, 0.5);
        }
        html.dark {
            --bg-color: #0f172a;
            --card-bg-color: #1e293b;
            --text-color: #e2e8f0;
            --text-muted-color: #94a3b8;
            --border-color: #334155;
            --primary-btn-bg: linear-gradient(45deg, #6366f1, #8b5cf6);
            --primary-btn-hover-bg: linear-gradient(45deg, #4f46e5, #7c3aed);
            --progress-bar-bg: #334155;
            --progress-bar-fill: #6366f1;
            --glow-color: rgba(99, 102, 241, 0.5);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .step-container {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .hidden { display: none; }
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .btn-primary { 
            background: var(--primary-btn-bg);
            background-size: 200% 200%;
            transition: background-position 0.5s, opacity 0.3s;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover { 
            background-position: right center;
        }
        .btn-primary:disabled {
            background: var(--text-muted-color);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .choice-card {
             position: relative;
             overflow: hidden;
        }
        .choice-card:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 0 20px 5px var(--glow-color);
        }
        .choice-card:hover .ph {
            animation: icon-bounce 0.6s;
        }
        .loader {
            width: 1rem; height: 1rem; border: 2px solid #fff;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite; margin-left: 0.5rem;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Animations */
        @keyframes slideInFromRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOutToLeft { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-30px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes icon-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .slide-in { animation: slideInFromRight 0.5s forwards; }
        .slide-out { animation: slideOutToLeft 0.5s forwards; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; animation-delay: var(--delay, 0s); opacity: 0; }
        
        /* New Robot Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(25deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(25deg); }
        }
        #waving-robot {
            animation: float 4s ease-in-out infinite;
        }
        #robot-arm {
            transform-origin: 150px 90px; /* Joint of the arm */
            animation: wave 2.5s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 600ms linear;
            background-color: rgba(255, 255, 255, 0.7);
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: -100px; left: 50%;
            transform: translateX(-50%); background-color: #22c55e; color: white;
            padding: 1rem 1.5rem; border-radius: 8px; font-weight: 500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: bottom 0.5s; z-index: 100;
        }
        #toast.show { bottom: 20px; }

        /* Progress Bar */
        #progress-bar-container {
            width: 100%;
            background-color: var(--progress-bar-bg);
            border-radius: 9999px;
            height: 8px;
            transition: background-color 0.3s;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--progress-bar-fill);
            border-radius: 9999px;
            transition: width 0.5s ease-out, background-color 0.3s;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- API Error Banner -->
    <div id="api-error-banner" class="hidden fixed top-0 left-0 right-0 bg-red-500 text-white p-3 text-center text-sm z-50">
        <strong>API Error:</strong> The Gemini API key is not configured. AI features will not work. Please add your key to the `apiKey` variable in the script.
    </div>
    
    <!-- Dark Mode Toggle -->
    <div class="fixed top-4 right-4 z-10">
        <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
            <div class="relative">
                <input type="checkbox" id="dark-mode-toggle" class="sr-only" onchange="toggleDarkMode()">
                <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
            </div>
        </label>
    </div>

    <div class="w-full max-w-2xl mx-auto">
        <!-- Progress Bar -->
        <div id="progress-bar-container" class="mb-4">
            <div id="progress-bar"></div>
        </div>

        <!-- Welcome Step -->
        <div id="welcome-step" class="step-container text-center card p-8 relative overflow-visible">
            
            <!-- Animated Robot -->
            <div id="waving-robot" class="hidden lg:block absolute -bottom-10 -right-16 w-48 h-48 pointer-events-none">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <!-- Body -->
                    <rect x="50" y="70" width="100" height="100" rx="15" fill="var(--card-bg-color)" stroke="var(--border-color)" stroke-width="4"/>
                    <!-- Head -->
                    <rect x="70" y="30" width="60" height="40" rx="10" fill="var(--card-bg-color)" stroke="var(--border-color)" stroke-width="4"/>
                    <circle cx="100" cy="20" r="5" fill="#4f46e5"/>
                    <!-- Eyes -->
                    <circle cx="85" cy="50" r="5" fill="#1e293b" class="dark:fill-white"/>
                    <circle cx="115" cy="50" r="5" fill="#1e293b" class="dark:fill-white"/>
                    <!-- Screen on body -->
                    <rect x="65" y="90" width="70" height="50" rx="5" fill="#e0e7ff" class="dark:fill-slate-700"/>
                    <text x="100" y="110" font-family="Inter, sans-serif" font-size="9" fill="#1e293b" class="dark:fill-slate-200" text-anchor="middle" font-weight="600">
                        <tspan x="100" dy="-9">BY CODING</tspan>
                        <tspan x="100" dy="12">AND</tspan>
                        <tspan x="100" dy="12">HARMONY</tspan>
                    </text>
                    <!-- Waving Arm -->
                    <g id="robot-arm">
                        <line x1="150" y1="90" x2="180" y2="60" stroke="var(--border-color)" stroke-width="12" stroke-linecap="round"/>
                        <circle cx="180" cy="60" r="8" fill="var(--card-bg-color)" stroke="var(--border-color)" stroke-width="4"/>
                    </g>
                    <!-- Other Arm -->
                    <line x1="50" y1="90" x2="20" y2="120" stroke="var(--border-color)" stroke-width="12" stroke-linecap="round"/>
                    <circle cx="20" cy="120" r="8" fill="var(--card-bg-color)" stroke="var(--border-color)" stroke-width="4"/>
                </svg>
            </div>

            <img src="https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" onerror="this.onerror=null;this.src='https://placehold.co/600x400/0f172a/e2e8f0?text=AI+Mentor';" alt="AI Career Mentorship" class="rounded-xl mb-6 w-full h-auto max-w-md mx-auto fade-in">
            <h1 class="text-3xl font-bold mt-4 fade-in" style="--delay: 0.1s;">Welcome to Your AI Mentor</h1>
            <p class="mt-4 text-muted-color fade-in" style="--delay: 0.2s;">I use AI to help you navigate your career path. Let's build a tailored roadmap just for you.</p>
            <button onclick="showStep('profile-step')" class="btn-primary mt-8 px-8 py-3 rounded-lg font-semibold fade-in" style="--delay: 0.4s;">Let's Get Started</button>
        </div>

        <!-- Profile Info Step -->
        <div id="profile-step" class="step-container hidden card p-8">
            <h2 class="text-2xl font-bold flex items-center"><i class="ph-user-list mr-3 text-2xl text-indigo-500"></i>Let's Build Your Profile</h2>
             <div class="mt-6 space-y-6">
                 <div class="fade-in">
                    <label for="name" class="block text-sm font-medium">What should I call you?</label>
                    <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-transparent" placeholder="Your Name">
                </div>
                <div class="fade-in" style="--delay: 0.1s;">
                    <label class="block text-sm font-medium">What are your key skills?</label>
                    <input type="text" id="skills-input" onkeydown="handleTagInput(event, 'skills')" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-transparent" placeholder="e.g., Python, C++. Press Enter to add.">
                    <div id="skills-tags" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="fade-in" style="--delay: 0.2s;">
                    <label class="block text-sm font-medium">What are your interests or hobbies?</label>
                    <input type="text" id="interests-input" onkeydown="handleTagInput(event, 'interests')" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-transparent" placeholder="e.g., AI, Writing. Press Enter to add.">
                    <div id="interests-tags" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                 <div class="fade-in" style="--delay: 0.3s;">
                    <label for="projects" class="block text-sm font-medium">Tell me about a project you're proud of. (Optional)</label>
                    <textarea id="projects" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-transparent"></textarea>
                </div>
                <div class="fade-in" style="--delay: 0.4s;">
                     <label for="ug-stream" class="block text-sm font-medium">Undergraduate Background</label>
                     <div class="flex space-x-2 mt-1">
                        <select id="ug-stream" class="block w-full rounded-md border-gray-300 shadow-sm bg-card-bg-color">
                            <option>B.Tech CSE</option>
                            <option>B.Tech ECE</option>
                            <option>B.Tech Mechanical</option>
                            <option>B.Com</option>
                            <option>BBA</option>
                            <option>B.A. History</option>
                            <option>B.A. Political Science</option>
                            <option>B.Sc. Physics</option>
                            <option>B.Sc. Chemistry</option>
                        </select>
                        <input type="text" id="ug-marks" class="block w-1/3 rounded-md border-gray-300 shadow-sm bg-transparent" placeholder="CGPA/%">
                     </div>
                </div>
                 <div class="fade-in" style="--delay: 0.5s;">
                    <label class="block text-sm font-medium">Upload Resume (Optional)</label>
                    <div id="resume-feedback" class="text-sm text-green-500 mt-1"></div>
                    <input type="file" id="resume" class="mt-1 block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                </div>
            </div>
            <div class="mt-8 flex justify-between items-center">
                <button onclick="showStep('welcome-step')" class="text-sm font-semibold text-muted-color hover:text-color transition-colors">← Back</button>
                <button onclick="saveProfileAndProceed()" class="btn-primary px-6 py-2 rounded-lg font-semibold">Next: Define Your Goal →</button>
            </div>
        </div>
        
        <!-- Career Direction Step -->
        <div id="direction-step" class="step-container hidden card p-8">
            <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-path mr-3 text-2xl text-indigo-500"></i>Choose Your Career Direction</h2>
            <p class="mt-2 text-muted-color">Hello <span id="user-name-placeholder" class="font-semibold text-color"></span>! What is your primary career goal right now?</p>
            <div class="mt-6 grid gap-6 sm:grid-cols-3">
                <div onclick="handleDirectionChoice('job-roles')" class="choice-card text-center p-6 border rounded-lg border-border-color cursor-pointer transition-all duration-300 fade-in" style="--delay: 0.1s;">
                    <div class="text-4xl"><i class="ph ph-briefcase"></i></div><h3 class="mt-4 text-lg font-semibold">Job Roles</h3><p class="mt-1 text-sm text-muted-color">Get an AI-powered learning roadmap.</p>
                </div>
                 <div onclick="handleDirectionChoice('higher-studies')" class="choice-card text-center p-6 border rounded-lg border-border-color cursor-pointer transition-all duration-300 fade-in" style="--delay: 0.2s;">
                    <div class="text-4xl"><i class="ph ph-graduation-cap"></i></div><h3 class="mt-4 text-lg font-semibold">Higher Studies</h3><p class="mt-1 text-sm text-muted-color">Find colleges and exam strategies.</p>
                </div>
                 <div onclick="handleDirectionChoice('competitive-exams')" class="choice-card text-center p-6 border rounded-lg border-border-color cursor-pointer transition-all duration-300 fade-in" style="--delay: 0.3s;">
                    <div class="text-4xl"><i class="ph ph-bank"></i></div><h3 class="mt-4 text-lg font-semibold">Competitive Exams</h3><p class="mt-1 text-sm text-muted-color">Discover resources for government jobs.</p>
                </div>
            </div>
            <div class="mt-8">
                <button onclick="showStep('profile-step')" class="text-sm font-semibold text-muted-color hover:text-color transition-colors">← Back to Profile</button>
            </div>
        </div>

        <!-- Dynamic Content Step (for paths) -->
        <div id="path-step" class="step-container hidden card p-8">
            <div id="path-content"></div>
            <div class="mt-8">
                <button onclick="showStep('direction-step')" class="text-sm font-semibold text-muted-color hover:text-color transition-colors">← Back to Directions</button>
            </div>
        </div>

        <!-- Summary Step -->
        <div id="summary-step" class="step-container hidden card p-8">
            <div id="summary-content-to-pdf">
                 <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-scroll mr-3 text-2xl text-indigo-500"></i>Your Personalized Career Plan</h2>
                <div class="mt-6 p-4 border rounded-lg bg-white/5 border-border-color fade-in">
                    <h3 class="font-semibold text-lg">👤 Profile Summary</h3>
                    <div id="summary-profile" class="mt-2 text-sm text-muted-color space-y-1"></div>
                </div>
                <div id="summary-plan" class="mt-4 fade-in" style="--delay: 0.2s;"></div>
                <div id="ai-features" class="mt-4 fade-in" style="--delay: 0.3s;"></div>
                <div id="project-ideas" class="mt-4"></div>
                 <div id="interview-prep" class="mt-4"></div>
                 <div id="resource-hub" class="mt-4 fade-in" style="--delay: 0.4s;"></div>
            </div>
            <div class="mt-8 flex justify-between items-center">
                 <button onclick="showStep(userData.direction === 'job-roles' || userData.direction === 'higher-studies' ? 'path-step' : 'direction-step')" class="text-sm font-semibold text-muted-color hover:text-color transition-colors">← Go Back</button>
                 <button id="download-pdf-btn" onclick="generatePDF()" class="btn-primary px-6 py-2 rounded-lg font-semibold">Download Report (PDF)</button>
            </div>
             <div class="mt-8 border-t border-border-color pt-6">
                <button onclick="showStep('feedback-step')" class="w-full btn-primary px-6 py-2 rounded-lg font-semibold">Finish & Give Feedback</button>
            </div>
        </div>

        <!-- Feedback & Goodbye Steps -->
        <div id="feedback-step" class="step-container hidden card p-8 text-center">
            <h2 class="text-2xl font-bold">👍 Was this helpful?</h2>
             <div class="mt-6 flex justify-center space-x-4">
                <button onclick="handleFeedback(true)" class="text-4xl p-4 rounded-full hover:bg-white/10 transition transform hover:scale-125">👍</button>
                <button onclick="handleFeedback(false)" class="text-4xl p-4 rounded-full hover:bg-white/10 transition transform hover:scale-125">👎</button>
             </div>
             <div id="feedback-response" class="mt-4 font-medium"></div>
             <div class="mt-6">
                <button onclick="showStep('summary-step')" class="text-sm font-semibold text-muted-color hover:text-color transition-colors">← Back to Summary</button>
            </div>
        </div>
        <div id="goodbye-step" class="step-container hidden card p-8 text-center relative">
             <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
             <i class="ph ph-rocket-launch text-5xl text-indigo-500"></i>
            <h2 class="text-2xl font-bold mt-4">👋 Thank You!</h2>
            <p class="mt-2 text-muted-color">Best of luck on your career journey, <span id="final-user-name"></span>!</p>
            <div class="mt-8 flex justify-center space-x-4">
                <button onclick="restart()" class="btn-secondary px-6 py-2 rounded-lg font-semibold">🔁 Start New Session</button>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // --- GEMINI API SETUP ---
        const apiKey = "AIzaSyCF7x2V7fqHNrTwdfgips-VhJjqH_qAuck"; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const userData = { name: '', skills: [], interests: [], projects: '', ugStream: '', ugMarks: '', direction: '', pathSelection: '' };
        
        const careerData = {
            'higher-studies': { streams: ['Engineering', 'Management', 'Medical', 'Law', 'Science', 'Arts'] },
            'competitive-exams': {
                exams: ['UPSC CSE', 'SSC CGL', 'IBPS PO', 'CDS', 'RRB NTPC'],
                details: {
                   'UPSC CSE': { resources: 'VisionIAS, Vajiram & Ravi, The Hindu, Unacademy', recruiters: 'UPSC for IAS, IPS, IFS, etc.' },
                   'SSC CGL': { resources: 'Adda247, Testbook, Paramount Coaching', recruiters: 'Staff Selection Commission (SSC)' },
                   'IBPS PO': { resources: 'Adda247, Oliveboard, Bankersadda', recruiters: 'IBPS for Public Sector Banks' },
                   'CDS': { resources: 'Pathfinder, Testbook, Unacademy', recruiters: 'UPSC for Indian Armed Forces' },
                   'RRB NTPC': { resources: 'Testbook, Adda247, WiFiStudy', recruiters: 'Railway Recruitment Boards (RRBs)' }
                }
            },
            'job-roles': {
                streamToRoles: {
                    'B.Tech CSE': ['Software Engineer', 'Data Analyst', 'AI/ML Engineer', 'Cybersecurity Analyst'],
                    'B.Tech ECE': ['Hardware Engineer', 'Embedded Systems Engineer', 'Telecommunications Specialist', 'VLSI Engineer'],
                    'B.Tech Mechanical': ['Mechanical Engineer', 'Automotive Engineer', 'Robotics Engineer', 'Aerospace Engineer'],
                    'B.Com': ['Financial Analyst', 'Accountant', 'Investment Banker', 'Tax Consultant'],
                    'BBA': ['Business Analyst', 'Marketing Manager', 'HR Specialist', 'Product Manager'],
                    'B.A. History': ['Archivist', 'Museum Curator', 'Policy Analyst', 'Heritage Manager'],
                    'B.A. Political Science': ['Policy Analyst', 'Public Relations Specialist', 'Journalist', 'Political Consultant'],
                    'B.Sc. Physics': ['Research Scientist', 'Data Analyst', 'Physicist', 'Technical Writer'],
                    'B.Sc. Chemistry': ['Chemist', 'Pharmacologist', 'Research Scientist', 'Food Technologist'],
                    'default': ['Data Analyst', 'Business Analyst', 'Marketing Manager', 'Content Creator']
                }
            },
            'resources': {
                'Software Engineer': { 'Job Boards': 'LinkedIn, AngelList', 'Communities': 'Stack Overflow, GitHub', 'Tools': 'VS Code, Docker' },
                'Data Analyst': { 'Job Boards': 'Kaggle Jobs, LinkedIn', 'Communities': 'Kaggle, /r/datascience', 'Tools': 'Tableau, Power BI, Jupyter' },
                'Financial Analyst': { 'Job Boards': 'eFinancialCareers, LinkedIn', 'Communities': 'Wall Street Oasis', 'Tools': 'Excel, Bloomberg Terminal' },
                'default': { 'Job Boards': 'LinkedIn, Indeed', 'Communities': 'Reddit (relevant subreddits)', 'Tools': 'Google Workspace' }
            }
        };

        const progressMap = { 'welcome-step': 0, 'profile-step': 25, 'direction-step': 50, 'path-step': 75, 'summary-step': 100, 'feedback-step': 100, 'goodbye-step': 100 };
        let currentStepId = 'welcome-step';

        // --- Core App Logic ---
        window.onload = () => {
            if (!apiKey) {
                document.getElementById('api-error-banner').classList.remove('hidden');
            }
            document.getElementById('resume').addEventListener('change', simulateResumeParse);
            checkDarkModePreference();
            showStep(currentStepId, true); // Initial load

            // Add ripple effect listener
            document.querySelectorAll('.btn-primary').forEach(button => {
                button.addEventListener('click', createRipple);
            });
        };

        function showStep(stepId, isInitial = false) {
            const currentStep = document.getElementById(currentStepId);
            const nextStep = document.getElementById(stepId);
            
            updateProgressBar(stepId);

            if (stepId === 'goodbye-step') {
                triggerConfetti();
            }

            if (isInitial) {
                if(nextStep) {
                    nextStep.classList.remove('hidden');
                    nextStep.classList.add('slide-in');
                    currentStepId = stepId;
                }
                return;
            }

            if (currentStep) {
                currentStep.classList.add('slide-out');
                setTimeout(() => {
                    currentStep.classList.add('hidden');
                    currentStep.classList.remove('slide-out');
                    if (nextStep) {
                        nextStep.classList.remove('hidden');
                        nextStep.classList.add('slide-in');
                        currentStepId = stepId;
                    }
                }, 500);
            }
        }
        
        function updateProgressBar(stepId) {
            const progress = progressMap[stepId] || 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement("span");
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.offsetLeft - radius}px`;
            circle.style.top = `${event.clientY - button.offsetTop - radius}px`;
            circle.classList.add("ripple");

            const ripple = button.getElementsByClassName("ripple")[0];
            if (ripple) {
                ripple.remove();
            }
            button.appendChild(circle);
        }

        // --- Profile Step Logic ---
        function handleTagInput(event, type) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const input = event.target;
            const value = input.value.trim();
            if (value && !userData[type].includes(value)) {
                userData[type].push(value);
                renderTags(type);
            }
            input.value = '';
        }

        function renderTags(type) {
            const container = document.getElementById(`${type}-tags`);
            container.innerHTML = userData[type].map(tag => `
                <span class="fade-in inline-flex items-center px-2.5 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                    ${tag}
                    <button class="ml-1.5 flex-shrink-0 text-indigo-500 hover:text-indigo-700" onclick="removeTag('${type}', '${tag}')">&times;</button>
                </span>`).join('');
        }

        function removeTag(type, tagToRemove) {
            userData[type] = userData[type].filter(tag => tag !== tagToRemove);
            renderTags(type);
        }

        function simulateResumeParse(event) {
            const feedbackDiv = document.getElementById('resume-feedback');
            if (!event.target.files.length) return;
            
            feedbackDiv.textContent = 'Parsing resume...';
            setTimeout(() => {
                const newSkills = ['Project Management', 'Agile Methodologies', 'Team Leadership'];
                const newInterests = ['Data Visualization', 'Machine Learning'];
                newSkills.forEach(s => { if (!userData.skills.includes(s)) userData.skills.push(s); });
                newInterests.forEach(i => { if (!userData.interests.includes(i)) userData.interests.push(i); });
                renderTags('skills');
                renderTags('interests');
                feedbackDiv.textContent = '✅ Resume parsed. Skills and interests have been added!';
            }, 1500);
        }

        function saveProfileAndProceed() {
            userData.name = document.getElementById('name').value;
            userData.projects = document.getElementById('projects').value;
            userData.ugStream = document.getElementById('ug-stream').value;
            userData.ugMarks = document.getElementById('ug-marks').value;
            document.getElementById('user-name-placeholder').textContent = userData.name || 'friend';
            showStep('direction-step');
        }

        // --- Career Path Logic ---
        function handleDirectionChoice(direction) {
            userData.direction = direction;
            const pathContent = document.getElementById('path-content');
            let contentHtml = '';

            if (direction === 'job-roles') {
                const relevantRoles = getRolesForStream();
                contentHtml = `
                    <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-briefcase mr-3 text-2xl text-indigo-500"></i>Job Role Suggestions for a ${userData.ugStream} Graduate</h2>
                    <p class="mt-2 text-muted-color">Based on your educational background, here are some roles that could be a great fit. Click one to generate a personalized roadmap with AI.</p>
                    <div class="mt-6 space-y-4">
                        ${relevantRoles.map((role, i) => `<button class="w-full text-left p-4 border rounded-lg hover:bg-white/10 border-border-color font-medium transition-colors fade-in" style="--delay: ${i * 0.1}s" onclick="generateAiRoadmap('${role}')"><i class="ph ph-magic-wand mr-2"></i> ${role}</button>`).join('')}
                    </div>`;
            } else if (direction === 'higher-studies') {
                contentHtml = `
                    <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-graduation-cap mr-3 text-2xl text-indigo-500"></i>Higher Studies</h2>
                    <p class="mt-2 text-muted-color">Select a field to get AI-powered recommendations for colleges and exam strategies.</p>
                    <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${careerData['higher-studies'].streams.map((stream, i) => `<button class="p-4 border rounded-lg hover:bg-white/10 border-border-color font-medium transition-colors fade-in" style="--delay: ${i * 0.1}s" onclick="generateAiHigherStudiesPlan('${stream}')">${stream}</button>`).join('')}
                    </div>`;
            } else { // Competitive Exams (static)
                contentHtml = `
                    <h2 class="text-2xl font-bold flex items-center"><i class="ph ph-bank mr-3 text-2xl text-indigo-500"></i>Competitive Exams</h2>
                    <p class="mt-2 text-muted-color">Which exam are you targeting?</p>
                    <div class="mt-6 grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${careerData['competitive-exams'].exams.map((exam, i) => `<button class="p-4 border rounded-lg hover:bg-white/10 border-border-color font-medium transition-colors fade-in" style="--delay: ${i * 0.1}s" onclick="generatePathResult('${direction}', '${exam}')">${exam}</button>`).join('')}
                    </div>`;
            }
            pathContent.innerHTML = contentHtml;
            showStep('path-step');
        }
        
        function getRolesForStream() {
            const stream = userData.ugStream;
            const streamMap = careerData['job-roles'].streamToRoles;
            return streamMap[stream] || streamMap['default'];
        }

        // --- Gemini API & AI Content Generation ---
        async function callGeminiAPI(prompt) {
            const maxRetries = 3;
            let delay = 1000;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        return candidate?.content?.parts?.[0]?.text || '<p class="text-red-500">Sorry, the AI returned an empty response.</p>';
                    }
                    if (response.status >= 500) { // Retry on server errors
                        if (i === maxRetries - 1) throw new Error(`API request failed with status ${response.status} after ${maxRetries} attempts.`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`API request failed with non-retryable status ${response.status}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) return `<p class="text-red-500">An error occurred: ${error.message}. Please try again later.</p>`;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }
        
        function setSummaryLoading(message) {
            const summaryPlanDiv = document.getElementById('summary-plan');
            const pdfBtn = document.getElementById('download-pdf-btn');
            
            pdfBtn.disabled = true;

            summaryPlanDiv.innerHTML = `<div class="flex items-center justify-center p-8"><div class="loader" style="width: 2rem; height: 2rem; border-color: var(--primary-btn-bg); border-bottom-color: transparent;"></div><p class="ml-4 text-muted-color">${message}</p></div>`;
            ['ai-features', 'project-ideas', 'interview-prep', 'resource-hub'].forEach(id => document.getElementById(id).innerHTML = '');
            populateSummary('');
            showStep('summary-step');
        }

        async function generateAiRoadmap(role) {
            userData.pathSelection = role;
            setSummaryLoading('✨ Generating your personalized AI roadmap...');
            const prompt = `Act as an expert career mentor. Create a concise, step-by-step learning roadmap for a user with a ${userData.ugStream} background who wants to become a "${role}". User skills: [${userData.skills.join(', ')}]. Interests: [${userData.interests.join(', ')}]. Keep descriptions for each step brief. Format as clean HTML with a title (<h3>), an ordered list (ol), and bolded step titles (<strong>).`;
            const roadmapHtml = await callGeminiAPI(prompt);
            document.getElementById('summary-plan').innerHTML = roadmapHtml;
            document.getElementById('ai-features').innerHTML = `
                <button id="project-idea-btn" onclick="generateProjectIdeas(this)" class="btn-primary mt-4 px-4 py-2 rounded-lg font-semibold"><i class="ph ph-lightbulb mr-2"></i>Suggest Portfolio Projects</button>
                <button id="interview-prep-btn" onclick="generateInterviewPrep(this)" class="btn-primary mt-4 ml-2 px-4 py-2 rounded-lg font-semibold"><i class="ph ph-microphone-stage mr-2"></i>Get Interview Prep</button>
            `;
            populateResourceHub(role);
            document.getElementById('download-pdf-btn').disabled = false;
        }
        
        async function generateAiHigherStudiesPlan(stream) {
            userData.pathSelection = stream;
            setSummaryLoading(`✨ Finding top colleges for ${stream}...`);
            const prompt = `Act as an expert admissions counselor specializing in Indian higher education. The user with a ${userData.ugStream} degree is interested in "${stream}" for higher studies in India. Skills: [${userData.skills.join(', ')}]. Provide a brief list of the top 3-4 universities in India for this field. Also, suggest key entrance exams and a brief preparation strategy. Keep all descriptions concise. Format as clean HTML with a main title (<h3>) and sections (<h4>) for 'Top Indian Universities', 'Key Entrance Exams', and 'Prep Strategy'.`;
            const planHtml = await callGeminiAPI(prompt);
            document.getElementById('summary-plan').innerHTML = planHtml;
            populateResourceHub(stream);
            document.getElementById('download-pdf-btn').disabled = false;
        }

        async function generateProjectIdeas(button) {
             const div = document.getElementById('project-ideas');
             const pdfBtn = document.getElementById('download-pdf-btn');
             pdfBtn.disabled = true;
             div.innerHTML = '<div class="flex items-center mt-4"><div class="loader" style="width: 1.5rem; height: 1.5rem; border-color: var(--primary-btn-bg); border-bottom-color: transparent;"></div><p class="ml-3 text-muted-color">✨ Brainstorming project ideas...</p></div>';
             button.disabled = true;
             const prompt = `Act as a mentor. Suggest 3 creative portfolio project ideas for an aspiring "${userData.pathSelection}" with a background in ${userData.ugStream}. For each project, provide a title (<h4>) and a brief 1-2 sentence description (<p>). Format as clean HTML.`;
             div.innerHTML = await callGeminiAPI(prompt);
             button.disabled = false;
             pdfBtn.disabled = false;
        }
        
        async function generateInterviewPrep(button) {
            const div = document.getElementById('interview-prep');
            const pdfBtn = document.getElementById('download-pdf-btn');
            pdfBtn.disabled = true;
            div.innerHTML = '<div class="flex items-center mt-4"><div class="loader" style="width: 1.5rem; height: 1.5rem; border-color: var(--primary-btn-bg); border-bottom-color: transparent;"></div><p class="ml-3 text-muted-color">✨ Generating interview questions...</p></div>';
            button.disabled = true;
            const prompt = `Act as a hiring manager. For a candidate applying for a "${userData.pathSelection}" role, generate 5 common interview questions. Provide a very brief, one-sentence tip for answering each one. Keep it concise. Format as clean HTML with a main title (<h3>), and an ordered list (ol) where each list item contains the question (<strong>) and the tip (<p>).`;
            div.innerHTML = await callGeminiAPI(prompt);
            button.disabled = false;
            pdfBtn.disabled = false;
        }

        // --- Summary & Final Steps ---
        function generatePathResult(direction, selection) {
            userData.pathSelection = selection;
            const details = careerData[direction].details[selection];
            const resultHtml = `<h3 class="font-semibold text-lg">Plan for ${selection}</h3><div class="mt-4 text-sm space-y-3"><p><strong>Prep Resources:</strong> ${details.resources}</p><p><strong>Key Recruiters:</strong> ${details.recruiters}</p></div>`;
            populateSummary(resultHtml);
            populateResourceHub(selection);
            showStep('summary-step');
            document.getElementById('download-pdf-btn').disabled = false;
        }
        
        function populateSummary(planHtml) {
            document.getElementById('summary-profile').innerHTML = `<p><strong>Name:</strong> ${userData.name || 'N/A'}</p><p><strong>Education:</strong> ${userData.ugStream} (${userData.ugMarks || 'N/A'})</p><p><strong>Skills:</strong> ${userData.skills.join(', ') || 'N/A'}</p><p><strong>Interests:</strong> ${userData.interests.join(', ') || 'N/A'}</p>`;
            if (planHtml) {
                document.getElementById('summary-plan').innerHTML = planHtml;
                 ['ai-features', 'project-ideas', 'interview-prep', 'resource-hub'].forEach(id => document.getElementById(id).innerHTML = '');
            }
        }
        
        function populateResourceHub(selection) {
            const resources = careerData.resources[selection] || careerData.resources.default;
            let hubHtml = `<h3 class="font-semibold text-lg mt-6">📚 Resource Hub</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">`;
            for (const category in resources) {
                hubHtml += `<div class="p-4 border rounded-lg bg-white/5 border-border-color fade-in" style="--delay: ${Object.keys(resources).indexOf(category) * 0.1}s">
                    <h4 class="font-semibold">${category}</h4>
                    <p class="text-sm text-muted-color">${resources[category]}</p>
                </div>`;
            }
            hubHtml += `</div>`;
            document.getElementById('resource-hub').innerHTML = hubHtml;
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('summary-content-to-pdf');
            const canvas = await html2canvas(content, { scale: 2, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color') });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save(`AI_Mentor_Report_${userData.name || 'User'}.pdf`);
        }

        function handleFeedback(isHelpful) {
            const responseDiv = document.getElementById('feedback-response');
            responseDiv.textContent = isHelpful ? "Fantastic! I'm glad I could help." : "Thank you for your feedback! I'm always learning.";
            document.getElementById('final-user-name').textContent = userData.name;
            setTimeout(() => showStep('goodbye-step'), 1500);
        }

        function restart() { location.reload(); }
        
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(canvas, {
                resize: true,
                useWorker: true
            });
            myConfetti({
                particleCount: 150,
                spread: 160
            });
        }

        // --- Helpers: Dark Mode, Clipboard ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }
        function checkDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-mode-toggle').checked = true;
            }
        }
        function copyToClipboard(elementId) {
            const content = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(content).then(() => {
                showToast('Copied to clipboard!');
            }, () => {
                showToast('Failed to copy.');
            });
        }
    </script>

</body>
</html>
